<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../aggregation-dialog/aggregation-dialog.html">
<link rel="import" href="../aggregation-display/aggregation-display.html">
<link rel="import" href="../aggregation-sort/aggregation-sort.html">
<link rel="import" href="../elastic-error/elastic-error.html">
<link rel="import" href="../facet-aggregation-query/facet-aggregation-query.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../select-all/select-all.html">
<link rel="import" href="../terms-transformer/terms-transformer.html">

<!--
A Polymer Element that performs an elasticsearch aggregation query and displays the list of results, which can then be used as term filters.

### Example
```html
    <facet-list
      name="city"
      title="Cities"
      text-property="id"
      client="[[esclient]]"
      index="mockads"
      process-request="{{processRequest}}"
      search-param-subset="{{searchParameters.city}}"
      search-parameters="{{searchParameters}}"
      index-types='["ad"]'
      combine-function="[[combineFunction]]"
      agg-field="city"
      query-builder-config="{{queryBuilderConfig}}">
    </facet-list>
```

@demo demo/index.html
-->

<dom-module id="facet-list">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }

      aggregation-dialog ::content .bar,
      aggregation-display ::content .bar {
        background-color: var(--facet-background-color);
      }

      aggregation-dialog ::content .bar-count,
      aggregation-display ::content .bar-count {
        color: var(--primary-text-color);
        font-weight: normal;
      }

      .filter-header {
        cursor: pointer;
        /* Match the font-weight of the Sort label */
        font-weight: 500;
        line-height: 24px;
      }

      .hide {
        display: none;
      }
    </style>

    <!-- title section of facet list -->
    <div id="header" class="layout horizontal facet filter-header" title="Toggle [[title]]" on-tap="toggleList">
      <span class="flex">[[_getTitleAndCount(title, limit, _resultList.length)]]</span>
      <iron-icon id="list-status-icon" icon$="[[_getToggleIcon(opened)]]"></iron-icon>
    </div>

    <!-- subheading with different options (sorting, select all, etc) along with query for facets list -->
    <facet-aggregation-query
      name="[[name]]"
      query-builder-config="[[queryBuilderConfig]]"
      search-parameters="[[searchParameters]]"
      match-all="[[searchOnEmptyParams]]"
      client="[[client]]"
      index="[[index]]"
      index-types="[[indexTypes]]"
      last-error="{{_error}}"
      loading="{{_loading}}"
      process-request="{{processRequest}}"
      field="[[aggField]]"
      count="{{_aggCount}}"
      sort-order="{{_sortOrder}}"
      result-list="{{_resultList}}"
      combine-function="[[combineFunction]]">
    </facet-aggregation-query>

    <elastic-error error="[[_error]]" message="{{_errorMessage}}"></elastic-error>

    <!-- transform the selected facets to the selected ids in the facets list and vice versa -->
    <terms-transformer
      category="[[title]]"
      list="{{_selectedList}}"
      object="{{searchParamSubset}}">
    </terms-transformer>

    <!-- display of results from aggregation query that user can check/uncheck -->
    <iron-collapse id="list" class="filter-list" opened="{{opened}}">
      <div class="horizontal layout">
        <div class="flex self-start">
          <aggregation-dialog
            text-property="[[textProperty]]"
            data="[[_resultList]]"
            dialog-header="[[_getTitleAndCount(title, _aggCount, _resultList.length)]]"
            error-message="[[_errorMessage]]"
            loading="[[_loading]]"
            header-data-name="[[title]]"
            header-counts-name="[[headerCountsName]]"
            show-checkboxes
            checkbox-name="Search"
            limit="{{_aggCount}}"
            order-by="{{_sortOrder}}"
            selected-ids="{{_selectedList}}">
          </aggregation-dialog>
        </div>
        <div class="self-end">
          <template is="dom-if" if="[[_resultList.length]]">
            <aggregation-sort order-by="{{_sortOrder}}"></aggregation-sort>
          </template>
        </div>
      </div>

      <select-all
        list="[[_resultList]]"
        loading="[[_loading]]"
        selected="{{_selectedList}}">
      </select-all>

      <aggregation-display
        small
        hide-show-more
        show-checkboxes
        checkbox-name="Search"
        text-property="[[textProperty]]"
        data="[[_resultList]]"
        limit="[[limit]]"
        error-message="[[_errorMessage]]"
        loading="[[_loading]]"
        selected-ids="{{_selectedList}}">
      </aggregation-display>
    </iron-collapse>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'facet-list',

      properties: {
        /**
         * (Required)
         *
         * The elasticsearch client.
         *
         * @type {Object}
         */
        client: {
          type: Object,
        },
        /**
         * (Required)
         *
         * The elasticsearch index to query.
         *
         * @type {String}
         */
        index: {
          type: String
        },
        /**
         * (Required)
         *
         * The elasticsearch index types to query.
         *
         * @type {Array}
         */
        indexTypes: {
          type: Array
        },
        /**
         * (Required)
         *
         * Name to use in facet-aggregation-query.
         *
         * @type {String}
         */
        name: {
          type: String
        },
        /**
         * (Required)
         *
         * Title to display in header.
         *
         * @type {String}
         */
        title: {
          type: String
        },
        /**
         * (Required)
         *
         * Query config object to pass to the facet-aggregation-query element. Consists of unique keys from
         * the searchParameter object mapped to config objects containing {String} field and (Optional)
         * {String} type.  Default type is "string".  Supported types are "string", "date"
         *
         * @type {Object}
         */
        queryBuilderConfig: {
          type: Object
        },
        /**
         * (Required)
         *
         * The parameters for the query in facet-aggregation-query.
         *
         * @type {Object}
         */
        searchParameters: {
          type: Object
        },
        /**
         * (Required)
         *
         * Subset of searchParameters to pass along to the terms-transformer.
         *
         * @type {Object}
         */
        searchParamSubset: {
          notify: true,
          type: Object
        },
        /**
         * (Required)
         *
         * Function used to create final _resultList.
         *
         * @type {Object}
         */
        combineFunction: {
          type: Object
        },
        /**
         * (Required)
         *
         * Field to aggregate on.
         *
         * @type {String}
         */
        aggField: {
          type: String
        },
        /**
         * (Required)
         *
         * Whether or not all properties are ready to create the elasticsearch query.
         *
         * @type {Boolean}
         */
        processRequest: {
          notify: true,
          type: Boolean
        },
        /**
         * (Optional)
         *
         * Text property in the objects in _resultList to pass along to the aggregation-display.
         *
         * @type {String}
         */
        textProperty: {
          type: String,
          value: 'text'
        },
        /**
         * (Optional)
         *
         * Image style class for aggregation-dialog (if any).
         *
         * @type {String}
         */
        imageStyleClass: {
          type: String
        },
        /**
         * (Optional)
         *
         * Max number shown in list of facets.
         *
         * @type {Number}
         * @default 10
         */
        limit: {
          type: Number,
          value: 10
        },
        /**
         * (Optional)
         *
         * Icon to use for when list of facets is opened.
         *
         * @type {String}
         * @default 'icons:expand-less'
         */
        openedIcon: {
          type: String,
          value: 'icons:expand-less'
        },
        /**
         * (Optional)
         *
         * Icon to use for when list of facets is collapsed.
         *
         * @type {String}
         * @default 'icons:expand-more'
         */
        closedIcon: {
          type: String,
          value: 'icons:expand-more'
        },
        /**
         * (Optional)
         *
         * Whether or not to perform a query when searchParameters are empty.
         *
         * @type {Boolean}
         * @default false
         */
        searchOnEmptyParams: {
          type: Boolean,
          value: false
        },
        /**
         * (Optional)
         *
         * Whether or not the list of facets is opened.
         *
         * @type {Boolean}
         * @default true
         */
        opened: {
          notify: true,
          type: Boolean,
          value: true
        },
        /**
         * (Optional)
         *
         * Count type to pass along to aggregation-dialog for text display.
         *
         * @type {String}
         * @default 'Ads'
         */
        headerCountsName: {
          type: String,
          value: 'Ads'
        },
        /**
         * Resulting list of items to show in list after combine function is applied to
         * original results returned from elasticsearch.
         *
         * @type {Array}
         * @private
         */
        _resultList: {
          type: Array
        },
        /**
         * List of checked items.
         *
         * @type {Array}
         * @private
         */
        _selectedList: {
          type: Array
        },
        /**
         * Whether or not the query is loading.
         *
         * @type {Boolean}
         * @private
         */
        _loading: {
          type: Boolean
        },
        /**
         * Number of results from aggregation query to obtain from elasticsearch.
         *
         * @type {Number}
         * @private
         */
        _aggCount: {
          type: Number
        },
        /**
         * Error returned by elasticsearch (if any).
         *
         * @type {Object}
         * @private
         */
        _error: {
          type: Object
        },
        /**
         * String representation of error message returned by elasticsearch (if any).
         *
         * @type {String}
         * @private
         */
        _errorMessage: {
          type: String
        },
        /**
         * Order in which to sort items shown in list (either default sorting of relevance or alphabetical).
         *
         * @type {String}
         * @default ''
         * @private
         */
        _sortOrder: {
          type: String,
          value: ''
        }
      },

      /**
       * Toggles the facet list open or closed.
       */
      toggleList: function() {
        this.$$('#list').toggle();
      },

      /**
       * Returns correct text to display as the header of the facet section based on the parameters.
       *
       * @param {String} title
       * @param {Number} limit
       * @param {Number} count
       * @return {String} header text
       * @private
       */
      _getTitleAndCount: function(title, limit, count) {
        return title + (count ? (count >= limit ? ' (Top ' + limit + ')' : ' (' + count + ')') : '');
      },

      /**
       * Returns the correct icon to display based on the current status of the 'opened' property.
       *
       * @param {Boolean} opened
       * @return {String} icon
       * @private
       */
      _getToggleIcon: function(opened) {
        return opened === false ? this.closedIcon : this.openedIcon;
      }
    });
  })();
  </script>
</dom-module>
